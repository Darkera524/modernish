#! /usr/bin/env modernish
use safe -w BUG_UPP -w BUG_APPENDC
use sys/traverse

# Test/demonstration program for sys/traverse

if command -v locale >/dev/null; then
	yes=$(locale yesexpr)
	no=$(locale noexpr)
else
	yes='^[Yy]'
	no='^[Nn]'
fi

showFileType() {
	quotedfnam=$1
	shellquote -f quotedfnam
	if isreg $1; then print "$quotedfnam is a regular file"
	elif isdir $1; then
		if not canread $1; then print "$quotedfnam is a directory in which you don't have read permission"
		elif isnonempty $1; then
			echo -n "$quotedfnam is a directory. Traverse it? (Y/n/stop) "
			read -r reply || return 3				# > 2: system failure
			if empty $reply || match -E $reply $yes; then return 0	# 0: do traverse
			elif match -E $reply $no; then return 1			# 1: prune (don't traverse)
			else return 2						# 2: stop
			fi
		else print "$quotedfnam is an empty directory"
		fi
	elif issymlink $1; then
		if not exists -L $1; then print "$quotedfnam is a symlink to a nonexistent file"
		elif isdir -L $1; then print "$quotedfnam is a symlink to a directory"
		elif isreg -L $1; then print "$quotedfnam is a symlink to a regular file"
		elif isdir -L $1; then print "$quotedfnam is a symlnk to a directory"
		elif isfifo -L $1; then print "$quotedfnam is a symlink to a named pipe"
		elif issocket -L $1; then print "$quotedfnam is a symlink to a socket"
		elif isblockspecial -L $1; then print "$quotedfnam is a symlink to a block special device"
		elif ischarspecial -L $1; then print "$quotedfnam is a symlink to a character special device"
		else die "showFileType: internal error: symlink to unknown file type: $quotedfnam"
		fi
	elif isfifo $1; then print "$quotedfnam is a named pipe"
	elif issocket $1; then print "$quotedfnam is a socket"
	elif isblockspecial $1; then print "$quotedfnam is a block special device"
	elif ischarspecial $1; then print "$quotedfnam is a character special device"
	else die "showFileType: internal error: unknown file type: $quotedfnam"
	fi
}

traverse ${1:-$HOME} showFileType
